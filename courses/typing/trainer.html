<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Интерактивный тренажер скоростной печати. Научитесь печатать вслепую на русской раскладке клавиатуры.">
    <meta name="keywords" content="скоростная печать, слепая печать, клавиатурный тренажер, десятипальцевый метод">
    <meta name="format-detection" content="telephone=no">
    <title>Тренажер скоростной печати</title>
    
    <!-- Favicon / Иконки сайта -->
    <link rel="icon" href="../../images/icon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="../../images/icon.ico" type="image/x-icon">
    
    <!-- Стили -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="stylesheet" href="../../css/mobile.css">
    <link rel="stylesheet" href="styles.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Montserrat', sans-serif;
            background: var(--background);
            color: var(--text);
            margin: 0;
            padding: 0;
        }
        
        .trainer-header {
            background-color: var(--header-bg);
            color: var(--header-text);
            padding: 15px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .trainer-header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        .trainer-title {
            font-size: 1.5rem;
            margin: 0;
        }
        
        .exit-btn {
            display: flex;
            align-items: center;
            color: var(--header-text);
            text-decoration: none;
            font-weight: 500;
            padding: 8px 12px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .exit-btn:hover {
            background-color: rgba(255,255,255,0.1);
        }
        
        .exit-btn svg {
            width: 30px;
            height: 30px;
        }
        
        .trainer-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        
        .trainer-wrapper {
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 30px;
        }
        
        .trainer-section {
            margin-bottom: 30px;
        }
        
        .trainer-section:last-child {
            margin-bottom: 0;
        }
        
        .trainer-section-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }
        
        /* Клавиатура */
        .keyboard-container {
            margin-top: 20px;
            max-width: 600px; /* Оптимальная ширина для читаемости */
            margin-left: auto;
            margin-right: auto;
        }

        .keyboard {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-bottom: 15px;
        }

        .keyboard-row {
            display: flex;
            justify-content: center;
            gap: 4px;
        }

        .key {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            transition: background-color 0.2s, color 0.2s;
            user-select: none;
            text-transform: uppercase;
            padding: 6px;
            height: 30px;
            min-width: 30px;
            box-sizing: border-box;
            position: relative;
        }

        .key.special {
            background-color: rgba(0, 0, 0, 0.2);
            color: rgba(255, 255, 255, 0.7);
            padding: 6px 10px;
        }

        .key.space {
            width: 200px;
        }

        .key.tab, .key.backspace, .key.caps, .key.enter, .key.shift {
            min-width: 60px;
        }

        .key.ctrl, .key.alt {
            min-width: 45px;
        }
        
        /* Стили для подсветки клавиш - только изменение цвета, никаких теней и трансформаций */
        .key.active {
            background-color: var(--primary);
            color: white;
        }
        
        .key.highlight {
            background-color: #7B38E7;
            color: white;
        }
        
        .key.correct {
            background-color: var(--success);
            color: white;
        }
        
        .key.incorrect {
            background-color: var(--danger);
            color: white;
        }
        
        .key.base-row {
            border: 1px solid var(--primary);
        }
        
        .key.upper-row {
            border: 1px solid #4169e1;
        }
        
        .key.lower-row {
            border: 1px solid #9c27b0;
        }
        
        /* Полностью скрываем визуализацию рук */
        .hands-container {
            display: none;
        }

        .hand, .finger, .finger-label {
            display: none;
        }
        
        /* Стили для текстового поля */
        .text-display-container {
            margin: 30px 0;
            position: relative;
        }
        
        .text-display {
            font-family: monospace;
            font-size: 1.5rem;
            text-align: left;
            padding: 20px;
            background-color: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            min-height: 120px;
            line-height: 1.6;
            white-space: pre-wrap;
            overflow-wrap: break-word;
        }
        
        .text-display span {
            display: inline-block;
            position: relative;
            margin: 0 1px;
        }
        
        .text-display span.active {
            background-color: rgba(67, 97, 238, 0.2);
            border-radius: 4px;
        }
        
        .text-display span.correct {
            color: var(--success);
        }
        
        .text-display span.incorrect {
            color: var(--danger);
            text-decoration: underline wavy var(--danger);
        }
        
        .text-input {
            position: absolute;
            top: -9999px;
            left: -9999px;
            opacity: 0;
        }
        
        /* Стили для статистики */
        .stats-container {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .stat-item {
            text-align: center;
            padding: 15px;
            min-width: 120px;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        /* Стили для кнопок управления */
        .controls-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
        }
        
        .control-btn {
            padding: 12px 25px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
        }
        
        .control-btn:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .control-btn.reset {
            background-color: var(--text-secondary);
        }
        
        .control-btn.reset:hover {
            background-color: var(--text);
        }
        
        /* Стили для прогресса */
        .progress-container {
            margin: 20px 0;
        }
        
        .progress-bar-container {
            height: 10px;
            background-color: var(--border);
            border-radius: 5px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background-color: var(--primary);
            transition: width 0.3s;
        }
        
        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        /* Стили для модального окна с результатами */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .modal-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .modal-stats {
            margin-bottom: 25px;
        }
        
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        
        /* Адаптивность */
        @media (max-width: 768px) {
            .trainer-wrapper {
                padding: 20px 15px;
            }
            
            .text-display {
                font-size: 1.2rem;
                padding: 15px;
            }
            
            .key {
                font-size: 0.6rem; /* Еще меньше для мобильных */
                padding: 0;
            }
            
            .stat-item {
                padding: 10px;
                min-width: 100px;
            }
            
            .stat-value {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Шапка -->
    <header class="trainer-header">
        <div class="trainer-header-container">
            <h1 class="trainer-title">Тренажер скоростной печати</h1>
            <a href="02-bazovyj-ryad.html" class="exit-btn" title="Вернуться к уроку">
                <svg width="30" height="30" viewBox="0 0 56 56" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect width="56" height="56" rx="15" fill="#7B38E7"/>
                    <path d="M34 21L23 28L34 35" stroke="white" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </a>
        </div>
    </header>

    <!-- Основной контент -->
    <main class="trainer-container">
        <div class="trainer-wrapper">
            <!-- Заголовок тренажера -->
            <section class="trainer-section">
                <h2 class="trainer-section-title">Интерактивный тренажер печати</h2>
                <p>Используйте этот тренажер для отработки навыков слепой печати. Следите за подсвеченными клавишами и пальцами на визуализаторе.</p>
                
                <div class="progress-container">
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                    </div>
                    <div class="progress-info">
                        <span id="progressText">0% завершено</span>
                        <span id="lessonInfo">Урок: Базовый ряд</span>
                    </div>
                </div>
            </section>
            
            <!-- Текстовое поле -->
            <section class="trainer-section">
                <div class="text-display-container">
                    <div class="text-display" id="textDisplay">
                        Нажмите "Начать" для запуска тренажера
                    </div>
                    <input type="text" class="text-input" id="textInput" autocomplete="off">
                </div>
                
                <div class="controls-container">
                    <button class="control-btn" id="startBtn">
                        <i class="fas fa-play"></i> Начать
                    </button>
                    <button class="control-btn reset" id="resetBtn">
                        <i class="fas fa-redo"></i> Сбросить
                    </button>
                </div>
            </section>
            
            <!-- Статистика -->
            <section class="trainer-section">
                <div class="stats-container">
                    <div class="stat-item">
                        <div class="stat-value" id="speedStat">0</div>
                        <div class="stat-label">Знаков/мин</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="accuracyStat">100%</div>
                        <div class="stat-label">Точность</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="timeStat">0:00</div>
                        <div class="stat-label">Время</div>
                    </div>
                </div>
            </section>
            
            <!-- Клавиатура -->
            <section class="trainer-section">
                <div class="keyboard-container">
                    <div class="keyboard" id="keyboard">
                        <!-- Клавиши будут добавлены с помощью JavaScript -->
                    </div>
                </div>
            </section>
        </div>
    </main>
    
    <!-- Модальное окно с результатами -->
    <div class="modal" id="resultsModal">
        <div class="modal-content">
            <h3 class="modal-title">Результаты тренировки</h3>
            <div class="modal-stats">
                <div class="stats-container">
                    <div class="stat-item">
                        <div class="stat-value" id="finalSpeedStat">0</div>
                        <div class="stat-label">Знаков/мин</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="finalAccuracyStat">100%</div>
                        <div class="stat-label">Точность</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="finalTimeStat">0:00</div>
                        <div class="stat-label">Время</div>
                    </div>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="control-btn" id="nextLessonBtn">
                    <i class="fas fa-forward"></i> Следующий урок
                </button>
                <button class="control-btn reset" id="retryBtn">
                    <i class="fas fa-redo"></i> Повторить
                </button>
            </div>
        </div>
    </div>

    <script>
        // Данные для клавиатуры (русская раскладка)
        const keyboardLayout = [
            ['ё', '1', '2', '3', '4', '5', '6', '7', '8', '9', '0', '-', '='],
            ['й', 'ц', 'у', 'к', 'е', 'н', 'г', 'ш', 'щ', 'з', 'х', 'ъ', '\\'],
            ['ф', 'ы', 'в', 'а', 'п', 'р', 'о', 'л', 'д', 'ж', 'э'],
            ['я', 'ч', 'с', 'м', 'и', 'т', 'ь', 'б', 'ю', '.'],
            [' ']
        ];

        // Специальные клавиши для каждого ряда
        const specialKeys = [
            { row: 0, position: 'after', keys: [{ text: 'BACK', class: 'backspace' }] },
            { row: 1, position: 'before', keys: [{ text: 'TAB', class: 'tab' }] },
            { row: 2, position: 'before', keys: [{ text: 'CAPS', class: 'caps' }] },
            { row: 2, position: 'after', keys: [{ text: 'ENTER', class: 'enter' }] },
            { row: 3, position: 'before', keys: [{ text: 'SHIFT', class: 'shift' }] },
            { row: 3, position: 'after', keys: [{ text: 'SHIFT', class: 'shift' }] },
            { row: 4, position: 'before', keys: [{ text: 'CTRL', class: 'ctrl' }, { text: 'ALT', class: 'alt' }] },
            { row: 4, position: 'after', keys: [{ text: 'ALT', class: 'alt' }, { text: 'CTRL', class: 'ctrl' }] }
        ];

        // Определение рядов клавиатуры
        const baseRowKeys = ['ф', 'ы', 'в', 'а', 'п', 'р', 'о', 'л', 'д', 'ж', 'э'];
        const upperRowKeys = ['й', 'ц', 'у', 'к', 'е', 'н', 'г', 'ш', 'щ', 'з', 'х', 'ъ'];
        const lowerRowKeys = ['я', 'ч', 'с', 'м', 'и', 'т', 'ь', 'б', 'ю', '.'];
        
        // Соответствие клавиш пальцам
        const fingerMap = {
            'ё': 'left-pinky', '1': 'left-pinky', '2': 'left-ring', '3': 'left-middle', '4': 'left-index', 
            '5': 'left-index', '6': 'right-index', '7': 'right-index', '8': 'right-middle', '9': 'right-ring', 
            '0': 'right-pinky', '-': 'right-pinky', '=': 'right-pinky', 'Back': 'right-pinky',
            
            'Tab': 'left-pinky', 'й': 'left-pinky', 'ц': 'left-ring', 'у': 'left-middle', 'к': 'left-index', 
            'е': 'left-index', 'н': 'right-index', 'г': 'right-index', 'ш': 'right-middle', 'щ': 'right-ring', 
            'з': 'right-pinky', 'х': 'right-pinky', 'ъ': 'right-pinky', '\\': 'right-pinky',
            
            'Caps': 'left-pinky', 'ф': 'left-pinky', 'ы': 'left-ring', 'в': 'left-middle', 'а': 'left-index', 
            'п': 'left-index', 'р': 'right-index', 'о': 'right-index', 'л': 'right-middle', 'д': 'right-ring', 
            'ж': 'right-pinky', 'э': 'right-pinky', 'Enter': 'right-pinky',
            
            'Shift': 'left-pinky', 'я': 'left-pinky', 'ч': 'left-ring', 'с': 'left-middle', 'м': 'left-index', 
            'и': 'left-index', 'т': 'right-index', 'ь': 'right-index', 'б': 'right-middle', 'ю': 'right-ring', 
            '.': 'right-pinky',
            
            'Ctrl': 'left-pinky', 'Alt': 'left-thumb', 'Пробел': 'right-thumb', ' ': 'right-thumb'
        };
        
        // Упражнения для тренировки (от простого к сложному)
        const lessons = [
            {
                id: 1,
                name: "Базовый ряд: начальные клавиши",
                description: "Освоение клавиш А и О",
                text: "а о а о а о аа оо аа оо ао оа ао оа аоао аоао оаоа оаоа аоаоао"
            },
            {
                id: 2,
                name: "Базовый ряд: расширение",
                description: "Добавляем клавиши В и Л",
                text: "в л в л в л вв лл вв лл вл лв вл лв влвл влвл лвлв лвлв авол авол лова лова авлоавло"
            },
            {
                id: 3,
                name: "Базовый ряд: полный набор",
                description: "Все клавиши базового ряда ФЫВА ОЛДЖ",
                text: "ф ы в а о л д ж фыва олдж фыва олдж фа ол ды вж фыва фыва олдж олдж фывафыва олджолдж фываолдж"
            },
            {
                id: 4,
                name: "Базовый ряд: слова",
                description: "Слова с использованием базового ряда",
                text: "вода лада фара жара выла дала вода лада фара жара выла дала лов вал дал лад жало дал вал лов"
            },
            {
                id: 5,
                name: "Верхний ряд: начальные клавиши",
                description: "Освоение клавиш К и Е",
                text: "к е к е к е кк ее кк ее ке ек ке ек кеке кеке екек екек кекеке"
            },
            {
                id: 6,
                name: "Верхний ряд: расширение",
                description: "Добавляем клавиши У и Н",
                text: "у н у н у н уу нн уу нн ун ну ун ну унун унун нуну нуну кену кену укен укен кенукену"
            },
            {
                id: 7,
                name: "Верхний ряд: полный набор",
                description: "Все клавиши верхнего ряда ЙЦУКЕ НГШЩЗ",
                text: "й ц у к е н г ш щ з йцуке нгшщз йцуке нгшщз йк цн уг еш кщ ез йцуке йцуке нгшщз нгшщз"
            },
            {
                id: 8,
                name: "Верхний и базовый ряды",
                description: "Комбинации клавиш верхнего и базового рядов",
                text: "ка ел ву ны ка ел ву ны каел вуны каел вуны кошка еда луна нора зона шары щука"
            },
            {
                id: 9,
                name: "Нижний ряд: начальные клавиши",
                description: "Освоение клавиш С и И",
                text: "с и с и с и сс ии сс ии си ис си ис сиси сиси исис исис сисиси"
            },
            {
                id: 10,
                name: "Нижний ряд: расширение",
                description: "Добавляем клавиши Ч и Т",
                text: "ч т ч т ч т чч тт чч тт чт тч чт тч чтчт чтчт тчтч тчтч сичт сичт итчс итчс ситчситч"
            },
            {
                id: 11,
                name: "Нижний ряд: полный набор",
                description: "Все клавиши нижнего ряда ЯЧСМИ ТЬБЮ.",
                text: "я ч с м и т ь б ю . ячсми тьбю. ячсми тьбю. яч см ит ьб ю. ячсми ячсми тьбю. тьбю."
            },
            {
                id: 12,
                name: "Все ряды: комбинации",
                description: "Комбинации клавиш всех рядов",
                text: "кот сад лес дом рука нога стол стул окно дверь книга ручка школа город страна работа"
            },
            {
                id: 13,
                name: "Предложения",
                description: "Короткие предложения для тренировки",
                text: "мама мыла раму. папа читал книгу. дети играли во дворе. солнце светит ярко. птицы поют весело."
            },
            {
                id: 14,
                name: "Абзацы",
                description: "Тренировка на абзацах текста",
                text: "утром я встаю рано. делаю зарядку и завтракаю. потом иду в школу. в школе я учусь хорошо. мне нравится читать книги и решать задачи. после школы я гуляю с друзьями. вечером делаю уроки и помогаю маме."
            },
            {
                id: 15,
                name: "Финальный тест",
                description: "Проверка навыков печати",
                text: "быстрая печать на клавиатуре это важный навык в современном мире. чтобы научиться печатать быстро и без ошибок нужно много практиковаться. регулярные тренировки помогут вам развить мышечную память и увеличить скорость набора текста. не смотрите на клавиатуру во время печати. это главное правило слепого метода."
            }
        ];

        // DOM элементы
        const keyboardElement = document.getElementById('keyboard');
        const textDisplayElement = document.getElementById('textDisplay');
        const textInputElement = document.getElementById('textInput');
        const startButton = document.getElementById('startBtn');
        const resetButton = document.getElementById('resetBtn');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const lessonInfoElement = document.getElementById('lessonInfo');
        const speedStatElement = document.getElementById('speedStat');
        const accuracyStatElement = document.getElementById('accuracyStat');
        const timeStatElement = document.getElementById('timeStat');
        const resultsModal = document.getElementById('resultsModal');
        const finalSpeedStatElement = document.getElementById('finalSpeedStat');
        const finalAccuracyStatElement = document.getElementById('finalAccuracyStat');
        const finalTimeStatElement = document.getElementById('finalTimeStat');
        const nextLessonButton = document.getElementById('nextLessonBtn');
        const retryButton = document.getElementById('retryBtn');
        
        // Переменные состояния
        let currentLessonIndex = 0;
        let currentLesson = lessons[currentLessonIndex];
        let currentText = "";
        let currentPosition = 0;
        let isTrainingActive = false;
        let startTime = null;
        let timerInterval = null;
        let correctKeystrokes = 0;
        let incorrectKeystrokes = 0;
        let totalKeystrokes = 0;
        let elapsedTimeInSeconds = 0;

        // Инициализация клавиатуры
        function initKeyboard() {
            keyboardElement.innerHTML = '';
            
            keyboardLayout.forEach((row, rowIndex) => {
                const rowContainer = document.createElement('div');
                rowContainer.className = 'keyboard-row';
                
                // Добавляем специальные клавиши в начало ряда
                const beforeSpecials = specialKeys.filter(sk => sk.row === rowIndex && sk.position === 'before');
                beforeSpecials.forEach(special => {
                    special.keys.forEach(key => {
                        const specialKey = document.createElement('div');
                        specialKey.className = `key special ${key.class}`;
                        specialKey.textContent = key.text;
                        specialKey.dataset.key = key.text.toLowerCase();
                        rowContainer.appendChild(specialKey);
                    });
                });
                
                // Добавляем обычные клавиши
                row.forEach((key, keyIndex) => {
                    const keyElement = document.createElement('div');
                    keyElement.className = 'key';
                    keyElement.textContent = key;
                    keyElement.dataset.key = key.toLowerCase();
                    
                    // Для пробела
                    if (key === ' ') {
                        keyElement.className = 'key space';
                        keyElement.textContent = 'ПРОБЕЛ';
                        keyElement.dataset.key = ' ';
                    }
                    
                    // Выделение клавиш по рядам
                    if (baseRowKeys.includes(key.toLowerCase())) {
                        keyElement.classList.add('base-row');
                    } else if (upperRowKeys.includes(key.toLowerCase())) {
                        keyElement.classList.add('upper-row');
                    } else if (lowerRowKeys.includes(key.toLowerCase())) {
                        keyElement.classList.add('lower-row');
                    }
                    
                    rowContainer.appendChild(keyElement);
                });
                
                // Добавляем специальные клавиши в конец ряда
                const afterSpecials = specialKeys.filter(sk => sk.row === rowIndex && sk.position === 'after');
                afterSpecials.forEach(special => {
                    special.keys.forEach(key => {
                        const specialKey = document.createElement('div');
                        specialKey.className = `key special ${key.class}`;
                        specialKey.textContent = key.text;
                        specialKey.dataset.key = key.text.toLowerCase();
                        rowContainer.appendChild(specialKey);
                    });
                });
                
                keyboardElement.appendChild(rowContainer);
            });
        }

        // Отображение текста урока
        function displayLessonText(text) {
            textDisplayElement.innerHTML = '';
            
            text.split('').forEach((char, index) => {
                const charSpan = document.createElement('span');
                charSpan.textContent = char;
                textDisplayElement.appendChild(charSpan);
            });
        }

        // Обновление статуса тренировки
        function updateTrainingStatus() {
            // Сбросить все состояния
            document.querySelectorAll('.key').forEach(key => {
                key.classList.remove('active', 'highlight', 'correct', 'incorrect');
            });
            
            document.querySelectorAll('.text-display span').forEach((span, index) => {
                span.classList.remove('active', 'correct', 'incorrect');
                
                if (index < currentPosition) {
                    span.classList.add('correct');
                } else if (index === currentPosition) {
                    span.classList.add('active');
                    
                    // Подсветить соответствующую клавишу
                    const currentChar = span.textContent.toLowerCase();
                    const keyElement = document.querySelector(`.key[data-key="${currentChar}"]`);
                    
                    if (keyElement) {
                        // Только меняем цвет фона, без эффектов положения
                        keyElement.classList.add('highlight');
                    }
                }
            });
            
            // Обновить индикатор прогресса
            const progressPercentage = Math.floor((currentPosition / currentText.length) * 100);
            progressBar.style.width = `${progressPercentage}%`;
            progressText.textContent = `${progressPercentage}% завершено`;
            
            // Обновить информацию об уроке
            lessonInfoElement.textContent = `Урок ${currentLessonIndex + 1}: ${currentLesson.name}`;
        }

        // Начать тренировку
        function startTraining() {
            // Загрузить текущий урок
            currentLesson = lessons[currentLessonIndex];
            currentText = currentLesson.text;
            
            // Отобразить текст урока
            displayLessonText(currentText);
            
            // Сбросить текущую позицию и статистику
            currentPosition = 0;
            correctKeystrokes = 0;
            incorrectKeystrokes = 0;
            totalKeystrokes = 0;
            
            // Обновить статус
            updateTrainingStatus();
            
            // Активировать флаг тренировки
            isTrainingActive = true;
            
            // Запустить таймер
            startTime = new Date();
            elapsedTimeInSeconds = 0;
            
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                elapsedTimeInSeconds++;
                updateStats();
            }, 1000);
            
            // Сфокусироваться на скрытом поле ввода
            textInputElement.value = '';
            textInputElement.focus();
            
            // Изменить текст кнопки
            startButton.innerHTML = '<i class="fas fa-pause"></i> Пауза';
        }

        // Сбросить тренировку
        function resetTraining() {
            isTrainingActive = false;
            currentPosition = 0;
            textDisplayElement.innerHTML = 'Нажмите "Начать" для запуска тренажера';
            startButton.innerHTML = '<i class="fas fa-play"></i> Начать';
            
            // Остановить таймер
            clearInterval(timerInterval);
            elapsedTimeInSeconds = 0;
            
            // Сбросить статистику
            correctKeystrokes = 0;
            incorrectKeystrokes = 0;
            totalKeystrokes = 0;
            updateStats();
            
            // Сбросить прогресс
            progressBar.style.width = '0%';
            progressText.textContent = '0% завершено';
            
            // Сбросить подсветку
            document.querySelectorAll('.key').forEach(key => {
                key.classList.remove('active', 'highlight', 'correct', 'incorrect');
            });
        }

        // Обновление статистики
        function updateStats() {
            // Скорость печати (знаков в минуту)
            const typingSpeed = elapsedTimeInSeconds > 0 
                ? Math.round((totalKeystrokes / elapsedTimeInSeconds) * 60) 
                : 0;
            
            // Точность печати
            const accuracy = totalKeystrokes > 0 
                ? Math.round((correctKeystrokes / totalKeystrokes) * 100) 
                : 100;
            
            // Форматирование времени
            const minutes = Math.floor(elapsedTimeInSeconds / 60);
            const seconds = elapsedTimeInSeconds % 60;
            const formattedTime = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            // Обновление элементов статистики
            speedStatElement.textContent = typingSpeed;
            accuracyStatElement.textContent = `${accuracy}%`;
            timeStatElement.textContent = formattedTime;
        }

        // Завершение тренировки
        function finishTraining() {
            // Остановить таймер
            clearInterval(timerInterval);
            
            // Деактивировать флаг тренировки
            isTrainingActive = false;
            
            // Обновить статистику в последний раз
            updateStats();
            
            // Заполнить данные в модальном окне
            finalSpeedStatElement.textContent = speedStatElement.textContent;
            finalAccuracyStatElement.textContent = accuracyStatElement.textContent;
            finalTimeStatElement.textContent = timeStatElement.textContent;
            
            // Показать модальное окно с результатами
            resultsModal.classList.add('active');
        }

        // Переход к следующему уроку
        function goToNextLesson() {
            if (currentLessonIndex < lessons.length - 1) {
                currentLessonIndex++;
            } else {
                currentLessonIndex = 0; // Вернуться к первому уроку после завершения всех
            }
            
            // Закрыть модальное окно
            resultsModal.classList.remove('active');
            
            // Начать новую тренировку
            startTraining();
        }

        // Повторить текущий урок
        function retryLesson() {
            // Закрыть модальное окно
            resultsModal.classList.remove('active');
            
            // Начать тренировку заново
            startTraining();
        }

        // Обработчик нажатия клавиш
        function handleKeyDown(e) {
            if (!isTrainingActive) return;
            
            const key = e.key.toLowerCase();
            
            // Предотвратить стандартное поведение для некоторых клавиш
            if (key === 'tab') {
                e.preventDefault();
            }
            
            // Если текущий символ соответствует нажатой клавише
            if (currentPosition < currentText.length) {
                const currentChar = currentText[currentPosition].toLowerCase();
                
                // Только для визуального отображения, не добавляем классы, меняющие размеры
                const keyElement = document.querySelector(`.key[data-key="${key}"]`);
                if (keyElement) {
                    // Очищаем все возможные классы, которые могут влиять на положение
                    keyElement.classList.remove('active', 'correct', 'incorrect');
                    // Добавляем только класс highlight для изменения цвета
                    keyElement.classList.add('highlight');
                    
                    // Через короткий промежуток времени убираем выделение
                    setTimeout(() => {
                        if (keyElement) {
                            keyElement.classList.remove('highlight');
                        }
                    }, 150);
                }
                
                // Увеличить счетчик нажатий
                totalKeystrokes++;
                
                // Проверить правильность ввода
                if (key === currentChar || 
                    (key === ' ' && currentChar === ' ') ||
                    (key === 'space' && currentChar === ' ')) {
                    // Правильный ввод
                    correctKeystrokes++;
                    
                    const spans = document.querySelectorAll('.text-display span');
                    if (spans[currentPosition]) {
                        spans[currentPosition].classList.remove('active');
                        spans[currentPosition].classList.add('correct');
                    }
                    currentPosition++;
                    
                    // Если достигнут конец текста
                    if (currentPosition >= currentText.length) {
                        finishTraining();
                    } else {
                        updateTrainingStatus();
                    }
                } else {
                    // Неправильный ввод
                    incorrectKeystrokes++;
                    
                    const currentSpan = document.querySelectorAll('.text-display span')[currentPosition];
                    if (currentSpan) {
                        currentSpan.classList.add('incorrect');
                        
                        // Добавить анимацию тряски только для текста, не для клавиши
                        currentSpan.classList.add('shake');
                        setTimeout(() => {
                            currentSpan.classList.remove('shake');
                        }, 500);
                    }
                }
                
                // Обновить статистику
                updateStats();
            }
        }

        // Инициализация
        document.addEventListener('DOMContentLoaded', () => {
            // Инициализировать клавиатуру
            initKeyboard();
            
            // Отключаем любые возможные анимации для клавиш
            document.querySelectorAll('.key').forEach(key => {
                key.style.animation = 'none';
                key.style.transform = 'none';
                key.style.boxShadow = 'none';
                key.style.transition = 'background-color 0.2s, color 0.2s';
            });
            
            // Добавить обработчики событий
            startButton.addEventListener('click', () => {
                if (isTrainingActive) {
                    isTrainingActive = false;
                    clearInterval(timerInterval);
                    startButton.innerHTML = '<i class="fas fa-play"></i> Продолжить';
                } else {
                    if (currentPosition === 0 || currentPosition >= currentText.length) {
                        startTraining();
                    } else {
                        isTrainingActive = true;
                        
                        // Возобновить таймер
                        timerInterval = setInterval(() => {
                            elapsedTimeInSeconds++;
                            updateStats();
                        }, 1000);
                        
                        startButton.innerHTML = '<i class="fas fa-pause"></i> Пауза';
                        textInputElement.focus();
                    }
                }
            });
            
            resetButton.addEventListener('click', resetTraining);
            
            // Слушатель событий клавиатуры для скрытого поля ввода
            textInputElement.addEventListener('keydown', handleKeyDown);
            
            // Клик по контейнеру тренажера фокусирует скрытое поле ввода
            document.querySelector('.text-display-container').addEventListener('click', () => {
                textInputElement.focus();
            });
            
            // Обработчики для модального окна
            nextLessonButton.addEventListener('click', goToNextLesson);
            retryButton.addEventListener('click', retryLesson);
            
            // Закрытие модального окна по клику вне его содержимого
            resultsModal.addEventListener('click', (e) => {
                if (e.target === resultsModal) {
                    resultsModal.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html> 